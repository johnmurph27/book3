<html>
<head>
    <style>
        .answer {
            min-height: 50px
        }
        section{
          padding: 10px;
          margin-bottom: 12px
        }
        .parallax-container {
          height: 300
        }
        #title {
          position: absolute;
          padding: 20px;
          font-size: 64px;
          font-weight: bolder;
          color: white;
          top: 100px;
          left: 0px;
          text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black
        }
        #title .authors {
          padding: 20px;
          font-size: 32px;
          font-weight: bolder;
          color: #BBB;
          text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/css/materialize.min.css">
</head>
<body>

  <div class="parallax-container">
    <div class="parallax">
      <img src="nepal.jpg">
      <h1 id="title">What are the patterns of image diffusion during the Nepal Earthquake?
        <div class="authors"></div>
      </h1>

    </div>
  </div>

  <div class="section white container flow-text">

      <div id="questions" class="collection with-header">
          <div class="collection-header">Questions</div>
          <section id="q1" class="question collection-item">
              <h4>What is the break up between hindu and nepali tweets?</h4>
              <div class="answer"></div>
          </section>

          

          
      </div>

  </div>

  <div class="parallax-container" style="height:200px">
    <div class="parallax">
      <img src="nepal2.jpg">
    </div>
  </div>


  <div class="section white container flow-text">
    <div class="markdown">

# Findings, Recommendations and Future Work


<ul type="disc">
    </div>
  </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.1/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.5/marked.min.js"></script>
    <script>

var items   // global scope (i.e., can be accessed in javascript console)

function solution1(){
    

    // Get original tweets
    var ot = _.filter(items,function(d){
        return d['Rt'] != "Retweet"
    })
    var otfollow = _.groupBy(ot, 'Tweet Language')
    console.log(otfollow)
    hiLength = otfollow['hi'].length
    neLength = otfollow['ne'].length
    hiPer = (hiLength / (hiLength+neLength) ) * 100
    nePer = (neLength / (hiLength+neLength) ) * 100

    console.log(hiPer)
    console.log(nePer)
    return "Percentage of Hindu tweets:"+ hiPer +"%\n Percentage of Nepali tweets: "+ nePer +"%\n"

    
    // Dataset is not complete so filter retweet counts to only those with
    // orinal tweets in the datase
 
}

function solution2(){
    var separators = [' ', '\\\+', '-', '\\\(', '\\\)', '\\*', '/', ':', '\\\?','_',',',';','____',"&",'/ ',': ',"#","!"];
  //var list = []
  var upperCase = _.memoize(function(string) {
    return string.toLowerCase();
  });
  var local = _.filter(items, function(x){
    var tokens = x['User Location'].split(new RegExp(separators.join('|'), 'g'));
    var list = []
    _.forEach(tokens,function(f){
      list = list.concat(upperCase(f))
    })
    return !(_.contains(list,"singapore"))&&!(_.contains(list,"russia"))&&!(_.contains(list,"usa"))&&!(_.contains(list,"japan"))&&!(_.contains(list,"australia"))
    &&!(_.contains(list,"london"))&&!(_.contains(list,"kuala"))&&!(_.contains(list,"india"))&&!(_.contains(list,"zealand"))&&!(_.contains(list,"adelaide"))
    &&!(_.contains(list,"ireland"))&&!(_.contains(list,"sudan"))&&!(_.contains(list,"canada"))&&!(_.contains(list,"malaysia"))
  })
  var international = _.filter(items,function(x){
    var tokens = x['User Location'].split(new RegExp(separators.join('|'), 'g'));
    var list = []
    _.forEach(tokens,function(f){
      list = list.concat(upperCase(f))
    })
    return (_.contains(list,"singapore"))||(_.contains(list,"russia"))||(_.contains(list,"usa"))||(_.contains(list,"japan"))||(_.contains(list,"australia"))
    ||(_.contains(list,"london"))||(_.contains(list,"kuala"))||(_.contains(list,"india"))||(_.contains(list,"zealand"))||(_.contains(list,"adelaide"))
    ||(_.contains(list,"ireland"))||(_.contains(list,"sudan"))||(_.contains(list,"canada"))||(_.contains(list,"malaysia"))
  })
  var int_rt = _.filter(international,function(x){
    return _.contains(x['Rt'],"Retweet")
  })
  var local_rt = _.filter(local,function(x){
    return _.contains(x['Rt'],"Retweet")
  })
  var int_percent = int_rt.length / international.length*100
  var local_percent = local_rt.length /local.length*100
  var proportion = local_percent/int_percent*100
  return "international retweet percentage is:"+int_percent+"%\n Local retweet percentage is: "+local_percent+"%\n proportion of local over international retweet is "+proportion + "%\n"
}

//
// Do tweets sent from influential tweeters have a longer lifespan?
//
function solution3(){
    // define a template string
    var tplString = '<g> \
            <circle cx="${d.x}" \
            cy="${d.y}" \
            r="4" \
            stroke="black" \
            fill="red" /> \
                    </g>'

    // compile the string to get a template function
    var template = _.template(tplString)

    // Group tweets by the image id
    var groups = _.groupBy(items, 'Image Id Str')

    console.log('groups', groups)

    // Find original tweets
    var images = _.mapValues(groups, function(tweets) {
        // A single image could originate from multiple tweets.
        originalTweets = _.filter(tweets, {'* Original Tweet Created At': ''})

        if (originalTweets) {
            // Followers count is the sum of follower counts for all orignal tweets
            followers = _.sum(_.pluck(originalTweets, 'User Followers Count'))

            // lifespan of tweet = death (maximum retweet date)
            // - birth (minimum creation date).
            birth = _.min(originalTweets, function(tweet) {
                return Date.parse(tweet['* Tweet Created At'])
            })
            death = _.max(tweets, function(tweet) {
                 return Date.parse(tweet['* Tweet Created At'])
            })

            lifespan = Date.parse(death['* Tweet Created At'])
                - Date.parse(birth['* Tweet Created At'])
            return [lifespan, followers]
        } else return [-1, 0]
    })

    // Extract entries with original tweet in data set
    var filteredImages = _.filter(_.values(images), function(image) {
        return image[0] >= 0
    })

    var noLife = _.filter(_.values(images), function(image) {
        return image[0] == 0
    }).length

    var unzippedFilteredImages = _.unzip(filteredImages)
    var maxLifespan = _.max(unzippedFilteredImages[0])
    var maxFollowers = _.max(unzippedFilteredImages[1])

    // X coordinate is the scaled time
    function computeX(d, i) {
        return 700 * d[0]/maxLifespan + 10
    }

    // Y coordinate is the scaled follower count
    function computeY(d, i) {
        return 180 * 10 * d[1]/maxFollowers + 10
    }

    var viz = _.map(filteredImages, function(d, i){
                return {
                    x: computeX(d, i),
                    y: computeY(d, i)
                }
             })

    var result = _.map(viz, function(d){
             // invoke the compiled template function on each viz data
             return template({d: d})
         })

    return '<svg width="100%" height="100%">' + result + '</svg>'
}

function run(id, solutionFunc, data){
    console.log('run solution for ' + id)
    var answer = solutionFunc(data)
    $(id).find('.answer').html(answer)
}

function loadDataThenRunSolutions(){
  // $.get('http://bigdatahci2015.github.io/data/twitter/nepal_local_tweets.json')
  $.get('../../week9/team/nepal_local_tweets.json')
    .done(function(data){

        items = data
        console.log('number of items loaded:', items.length)
        console.log('first item', items[0])

       run('#q1', solution1, items)
       run('#q2', solution2, items)
       run('#q3', solution3, items)
     })
     .fail(function(err){
         console.error(err)
     })
}

loadDataThenRunSolutions()

// convert Markdown to html
$('.markdown').each(function(){
  var markdownText = $(this).text()
  $(this).html(marked(markdownText))
})

// initialize the parallax effect
$(document).ready(function(){
  console.log($('.parallax').html())
    $('.parallax').parallax()
})

    </script>

</body>
</html>